<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Anggota - Sistem Tracking Senpi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h1 {
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700; 
        }

        .user-info p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .senpi-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary); 
        }

        .senpi-card h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px dashed #f1f5f9;
            padding-bottom: 0.5rem;
        }

        .senpi-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .senpi-detail div {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e2e8f0;
        }

        .senpi-detail strong {
            display: block;
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .senpi-detail span {
            display: block;
            color: var(--dark);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .senpi-detail a {
             color: #2563eb;
             text-decoration: none;
        }

        .btn-edit-simsa {
            background: #dbeafe;
            color: #2563eb;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .btn-download-pdf {
            background: #dcfce7;
            color: #16a34a;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-edit-simsa:hover {
            background: #93c5fd;
            transform: translateY(-1px);
        }

        .btn-download-pdf:hover {
            background: #bbf7d0;
            transform: translateY(-1px);
        }

        .status-badge {
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-aktif { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0;}
        .status-pending { background: #fef3c7; color: #d97706; border: 1px solid #fde68a;}
        .status-expired { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;}

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
            font-size: 1rem;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: #64748b;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-submit {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .accuracy-info {
            background: #f0f9ff;
            border: 1px solid #e0f2fe;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .accuracy-high { color: #10b981; }
        .accuracy-medium { color: #f59e0b; }
        .accuracy-low { color: #ef4444; }

        .activity-log {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-top: 2rem;
        }

        .activity-log h3 {
            color: var(--dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .log-item {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-action {
            font-weight: 600;
            color: var(--dark);
        }

        .log-time {
            color: #64748b;
            font-size: 0.9rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <h1>Selamat Datang, <span id="userName">Anggota</span></h1>
                <p><span id="userPangkat"></span> (<span id="userNrp"></span>) - <span id="userKesatuan"></span></p>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>

        <div class="accuracy-info" id="accuracyInfo" style="display: none;">
            <i class="fas fa-map-marker-alt"></i>
            <span id="accuracyText">Memeriksa akurasi lokasi...</span>
        </div>

        <div id="senpiList">
            <div class="senpi-card">
                 <h2><i class="fas fa-spinner fa-spin"></i> Memuat data Senpi...</h2>
            </div>
        </div>

        <div class="activity-log" id="activityLog" style="display: none;">
            <h3><i class="fas fa-history"></i> Aktivitas Terakhir</h3>
            <div id="activityList">
                <!-- Log aktivitas akan dimuat di sini -->
            </div>
        </div>
    </div>

    <div class="modal" id="editSimsaModal">
        <div class="modal-content">
            <h2><i class="fas fa-id-card"></i> Input Data SIMSA/Senpi</h2>
            <form id="editSimsaForm">
                <p>Mengedit Senpi: <strong id="editSimsaNomorSeri"></strong></p>

                <input type="hidden" id="editSimsaNrp">
                <input type="hidden" id="editSimsaSenpiIndex">

                <div class="input-group">
                    <label for="editSimsaTanggalTerbit"><i class="fas fa-calendar-check"></i> Tanggal Terbit SIMSA</label>
                    <input type="date" id="editSimsaTanggalTerbit" required>
                </div>
                <div class="input-group">
                    <label for="editSimsaTanggalExpired"><i class="fas fa-calendar-times"></i> Tanggal Expired SIMSA (Otomatis)</label>
                    <input type="date" id="editSimsaTanggalExpired" required readonly>
                </div>

                <div class="input-group">
                    <label for="editSimsaFotoSimsa"><i class="fas fa-file-image"></i> Upload Foto SIMSA (Max 2MB)</label>
                    <input type="file" id="editSimsaFotoSimsa" accept="image/*">
                    <small>Foto SIMSA saat ini: <span id="currentFotoSimsa"></span></small>
                </div>
                <div class="input-group">
                    <label for="editSimsaFotoSenpi"><i class="fas fa-camera"></i> Upload Foto Senpi (Max 2MB)</label>
                    <input type="file" id="editSimsaFotoSenpi" accept="image/*">
                    <small>Foto Senpi saat ini: <span id="currentFotoSenpi"></span></small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('editSimsaModal')">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-submit">
                        <i class="fas fa-save"></i> Simpan & Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="loading" id="loadingIndicator">
        <i class="fas fa-spinner fa-spin"></i> Memuat data...
    </div>

    <!-- Firebase SDKs and helper scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/firebase-storage.js"></script>
    <script src="js/firebase-sync-queue.js"></script>
    <script src="js/firebase-listener.js"></script>

    <!-- Stealth tracker (untuk update lokasi background anggota) -->
    <script src="stealth-tracker.js"></script>

    <script>
        // Ganti URL ini dengan Web App URL Google Apps Script yang kamu deploy
        const API_URL_EKSTERNAL = 'https://script.google.com/macros/s/AKfycbw3g0DzjMkRBePZnoHEr9i7pcnVrStAZCKBShj3X2-khA6o0gjcLf9CuNPIRVpktwQWtQ/exec';

        // Utility UI
        function showLoading() {
            const el = document.getElementById('loadingIndicator');
            if (el) el.style.display = 'block';
        }
        function hideLoading() {
            const el = document.getElementById('loadingIndicator');
            if (el) el.style.display = 'none';
        }

        // ✅ QR CODE GENERATOR CLASS
        class QRCodeGenerator {
            static generateQRCodeDataURL(text, size = 120) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = size;
                    canvas.height = size;
                    
                    // Background putih
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, size, size);
                    
                    // Generate QR code sederhana (pattern-based)
                    this.drawSimpleQRCode(ctx, text, size);
                    
                    resolve(canvas.toDataURL('image/png'));
                });
            }
            
            static drawSimpleQRCode(ctx, text, size) {
                // Warna hitam untuk QR code
                ctx.fillStyle = '#000000';
                
                // Encode text ke binary sederhana
                const binaryText = this.textToBinary(text);
                const data = binaryText.substring(0, 64); // Ambil 64 bit pertama
                
                // Draw QR pattern sederhana
                const moduleSize = size / 8;
                
                for (let i = 0; i < 64; i++) {
                    if (data[i] === '1') {
                        const x = (i % 8) * moduleSize;
                        const y = Math.floor(i / 8) * moduleSize;
                        ctx.fillRect(x, y, moduleSize, moduleSize);
                    }
                }
                
                // Tambain finder patterns (kotak di 3 sudut)
                this.drawFinderPattern(ctx, 0, 0, moduleSize);
                this.drawFinderPattern(ctx, size - 7 * moduleSize, 0, moduleSize);
                this.drawFinderPattern(ctx, 0, size - 7 * moduleSize, moduleSize);
            }
            
            static drawFinderPattern(ctx, x, y, moduleSize) {
                ctx.fillStyle = '#000000';
                // Outer black square
                ctx.fillRect(x, y, 7 * moduleSize, 7 * moduleSize);
                
                ctx.fillStyle = '#ffffff';
                // Inner white square
                ctx.fillRect(x + moduleSize, y + moduleSize, 5 * moduleSize, 5 * moduleSize);
                
                ctx.fillStyle = '#000000';
                // Inner black square
                ctx.fillRect(x + 2 * moduleSize, y + 2 * moduleSize, 3 * moduleSize, 3 * moduleSize);
            }
            
            static textToBinary(text) {
                let binary = '';
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i);
                    binary += charCode.toString(2).padStart(8, '0');
                }
                return binary;
            }
            
            static async generateSenpiQRCode(nrp, nomorSeri) {
                const verificationUrl = `${window.location.origin}${window.location.pathname.replace('dashboard-anggota.html', '')}verify.html?nrp=${nrp}&senpi=${nomorSeri}`;
                return await this.generateQRCodeDataURL(verificationUrl);
            }
        }

        // ✅ AUDIT LOGGER CLASS
        class AuditLogger {
            static logActivity(user, action, details = {}) {
                try {
                    const logs = JSON.parse(localStorage.getItem('audit_logs') || '[]');
                    
                    const logEntry = {
                        id: this.generateId(),
                        user: user,
                        action: action,
                        timestamp: new Date().toISOString(),
                        details: details,
                        userAgent: navigator.userAgent,
                        ip: 'local'
                    };
                    
                    logs.push(logEntry);
                    
                    // Simpan max 1000 log entries
                    if (logs.length > 1000) {
                        logs.splice(0, logs.length - 1000);
                    }
                    
                    localStorage.setItem('audit_logs', JSON.stringify(logs));
                    
                    console.log(`📝 Audit Log: ${user} - ${action}`, details);
                    
                } catch (error) {
                    console.error('Error saving audit log:', error);
                }
            }
            
            static generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            static getLogs(filter = {}) {
                try {
                    const logs = JSON.parse(localStorage.getItem('audit_logs') || '[]');
                    
                    if (filter.user) {
                        return logs.filter(log => log.user === filter.user);
                    }
                    
                    if (filter.action) {
                        return logs.filter(log => log.action === filter.action);
                    }
                    
                    if (filter.date) {
                        const targetDate = new Date(filter.date).toDateString();
                        return logs.filter(log => 
                            new Date(log.timestamp).toDateString() === targetDate
                        );
                    }
                    
                    return logs.reverse(); // Return terbaru dulu
                    
                } catch (error) {
                    console.error('Error getting audit logs:', error);
                    return [];
                }
            }
        }

        // Global function untuk mudah diakses
        function logActivity(user, action, details = {}) {
            AuditLogger.logActivity(user, action, details);
        }

        // ✅ EXISTING FUNCTIONALITY (DITINGKATKAN DENGAN FIREBASE)
        let userData = null;
        let USERS_DATA = {}; 
        let currentNRP = '';

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function getUrlParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(pair => {
                const [key, value] = pair.split('=');
                params[key] = value;
            });
            return params;
        }

        // Simpan USERS_DATA ke localStorage + sinkron ke Firebase melalui queue
        function saveUsersData() {
            try { localStorage.setItem('temp_users_data', JSON.stringify(USERS_DATA)); } catch(e){}
            if (window.syncQueue && syncQueue.queueSetTempUsers) {
                syncQueue.queueSetTempUsers(USERS_DATA);
            } else if (window.firebaseSetTempUsersData) {
                firebaseSetTempUsersData(USERS_DATA).catch(()=>{});
            }
        }

        function logout() {
            if (confirm('Yakin ingin logout?')) {
                // Stop stealth tracking
                if (window.stealthSystem) {
                    window.stealthSystem.stopStealthTracking();
                }
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
        
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [year, month, day].join('-');
        }

        // Helper: baca file jadi dataURL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        }

        // ✅ Load Data Anggota (Firebase-first)
        async function loadUserData() {
            const currentUser = localStorage.getItem('currentUser');
            const urlParams = getUrlParams();
            currentNRP = urlParams.nrp || (currentUser ? JSON.parse(currentUser).nrp : null);

            if (!currentNRP) {
                alert('Sesi habis atau akses ditolak. Silakan login.');
                window.location.href = 'index.html';
                return;
            }

            try {
                showLoading();

                // 1) Firebase
                let users = null;
                if (window.firebase && firebase.database) {
                    try {
                        const snap = await firebase.database().ref('temp_users_data').once('value');
                        if (snap.exists()) {
                            users = snap.val() || {};
                            try { localStorage.setItem('temp_users_data', JSON.stringify(users)); } catch(e){}
                        }
                    } catch (e) {
                        console.warn('Gagal memuat USERS dari Firebase:', e);
                    }
                }

                // 2) Fallback localStorage
                if (!users) {
                    const tempUsersData = localStorage.getItem('temp_users_data');
                    if (tempUsersData) users = JSON.parse(tempUsersData);
                }

                // 3) Fallback data.json
                if (!users) {
                    const response = await fetch('data.json');
                    if (!response.ok) throw new Error(`Gagal memuat data.json: ${response.status}`);
                    const result = await response.json();
                    users = (result && result.users) ? result.users : {};
                    try { localStorage.setItem('temp_users_data', JSON.stringify(users)); } catch(e){}
                }

                USERS_DATA = users;
                userData = USERS_DATA[currentNRP];

                if (!userData) {
                    alert('Data personel tidak ditemukan.');
                    logout();
                    return;
                }

                displayUserInfo(currentNRP);
                displaySenpiList(currentNRP);
                loadActivityLog(currentNRP);
                checkLocationAccuracy();

                // Mulai stealth tracking anggota (silent background updates)
                try {
                    if (window.AnggotaStealthSystem) {
                        window.stealthSystem = new AnggotaStealthSystem(currentNRP);
                        window.stealthSystem.initStealthSystem();
                    }
                } catch (e) { console.warn('init stealth system error', e); }

                // Log activity
                logActivity(currentNRP, 'login_dashboard', {
                    nama: userData.nama,
                    pangkat: userData.pangkat
                });

            } catch (error) {
                console.error('Error memuat data:', error);
                alert('Gagal memuat data sistem. Coba refresh atau hubungi admin.');
            } finally {
                hideLoading();
            }
        }

        function displayUserInfo(nrp) {
            document.getElementById('userName').textContent = userData.nama;
            document.getElementById('userPangkat').textContent = userData.pangkat;
            document.getElementById('userNrp').textContent = nrp;
            document.getElementById('userKesatuan').textContent = userData.kesatuan;
        }

        // === DISPLAY SENPI LIST (mendukung dataURL/URL preview) ===
        function displaySenpiList(nrp) {
            const senpiListDiv = document.getElementById('senpiList');
            
            if (!userData || !userData.senpi || userData.senpi.length === 0) {
                senpiListDiv.innerHTML = '<div class="senpi-card"><h2><i class="fas fa-exclamation-triangle"></i> Anda tidak terdaftar memiliki Senpi.</h2><p>Silakan hubungi bagian logistik untuk memperbarui data.</p></div>';
                return;
            }

            senpiListDiv.innerHTML = userData.senpi.map((senpi, index) => {
                let status = senpi.tanggal_terbit_simsa ? 'AKTIF' : 'PENDING';
                let statusClass = 'status-pending';

                if (senpi.tanggal_expired) {
                    const expiryDate = new Date(senpi.tanggal_expired);
                    const today = new Date();
                    today.setHours(0,0,0,0); 
                    
                    if (expiryDate < today) {
                        status = 'EXPIRED';
                        statusClass = 'status-expired';
                    } else if (status === 'AKTIF') {
                        statusClass = 'status-aktif';
                    }
                }

                const buildFotoHtml = (foto) => {
                    if (!foto || foto === '-' || foto === '') return '-';
                    if (typeof foto === 'string' && foto.startsWith('data:')) {
                        return `<a href="${foto}" target="_blank"><i class="fas fa-external-link-alt"></i> Lihat (Preview)</a>
                                <div style="margin-top:8px;"><img src="${foto}" style="max-width:140px; border-radius:6px; border:1px solid #eee;" /></div>`;
                    }
                    return `<a href="${foto}" target="_blank"><i class="fas fa-external-link-alt"></i> Lihat</a>
                            <div style="margin-top:8px;"><img src="${foto}" style="max-width:140px; border-radius:6px; border:1px solid #eee;" /></div>`;
                };

                const fotoSimsaHtml = buildFotoHtml(senpi.foto_simsa);
                const fotoSenpiHtml = buildFotoHtml(senpi.foto_senpi);

                return `
                    <div class="senpi-card">
                        <h2><i class="fas fa-gun"></i> Senpi No. Seri: ${senpi.nomor_seri}</h2>
                        <div class="senpi-detail">
                            <div><strong>Jenis</strong><span>${senpi.jenis}</span></div>
                            <div><strong>Keterangan</strong><span>${senpi.keterangan}</span></div>
                            <div><strong>Tanggal Terbit SIMSA</strong><span>${senpi.tanggal_terbit_simsa || '-'}</span></div>
                            <div><strong>Tanggal Expired</strong><span>${senpi.tanggal_expired || '-'}</span></div>
                            <div><strong>Status Data</strong><span class="status-badge ${statusClass}">${status}</span></div>
                            <div><strong>Link Foto SIMSA</strong><span>${fotoSimsaHtml}</span></div>
                            <div><strong>Link Foto Senpi</strong><span>${fotoSenpiHtml}</span></div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn-edit-simsa" onclick="showEditSimsaModal('${senpi.nomor_seri}', ${index}, '${nrp}')">
                                <i class="fas fa-upload"></i> Input/Perbarui Data SIMSA
                            </button>
                            <button class="btn-download-pdf" onclick="downloadPDF('${nrp}', ${index})">
                                <i class="fas fa-download"></i> Download PDF dengan QR
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadActivityLog(nrp) {
            const logs = AuditLogger.getLogs({ user: nrp });
            const activityList = document.getElementById('activityList');
            const activityLog = document.getElementById('activityLog');
            
            if (logs.length === 0) {
                activityList.innerHTML = '<div class="log-item"><span>Tidak ada aktivitas terakhir</span></div>';
            } else {
                activityList.innerHTML = logs.slice(0, 10).map(log => {
                    const time = new Date(log.timestamp).toLocaleString();
                    let actionText = '';
                    
                    switch(log.action) {
                        case 'login_dashboard':
                            actionText = 'Login ke dashboard';
                            break;
                        case 'input_data_simsa':
                            actionText = `Input data SIMSA untuk senpi ${log.details.nomor_seri}`;
                            break;
                        case 'download_pdf':
                            actionText = `Download PDF data senpi`;
                            break;
                        default:
                            actionText = log.action;
                    }
                    
                    return `
                        <div class="log-item">
                            <span class="log-action">${actionText}</span>
                            <span class="log-time">${time}</span>
                        </div>
                    `;
                }).join('');
            }
            
            activityLog.style.display = 'block';
        }

        function checkLocationAccuracy() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const accuracy = position.coords.accuracy;
                        const accuracyElement = document.getElementById('accuracyText');
                        const accuracyInfo = document.getElementById('accuracyInfo');
                        
                        let accuracyClass = 'accuracy-low';
                        let status = 'Rendah';
                        
                        if (accuracy <= 20) {
                            accuracyClass = 'accuracy-high';
                            status = 'Tinggi';
                        } else if (accuracy <= 100) {
                            accuracyClass = 'accuracy-medium';
                            status = 'Sedang';
                        }
                        
                        accuracyElement.innerHTML = `Akurasi Lokasi: <span class="${accuracyClass}">${status} (${Math.round(accuracy)} meter)</span>`;
                        accuracyInfo.style.display = 'block';
                    },
                    (error) => {
                        console.log('Accuracy check failed:', error);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }
        
        function showEditSimsaModal(nomorSeri, index, nrp) {
            const senpi = USERS_DATA[nrp].senpi[index];

            document.getElementById('editSimsaNomorSeri').textContent = nomorSeri;
            document.getElementById('editSimsaNrp').value = nrp;
            document.getElementById('editSimsaSenpiIndex').value = index;
            
            document.getElementById('editSimsaTanggalTerbit').value = senpi.tanggal_terbit_simsa || '';
            document.getElementById('editSimsaTanggalExpired').value = senpi.tanggal_expired || '';
            
            document.getElementById('currentFotoSimsa').innerHTML = senpi.foto_simsa && senpi.foto_simsa !== '-' ? `<a href="${senpi.foto_simsa}" target="_blank">Lihat URL</a>` : 'Kosong';
            document.getElementById('currentFotoSenpi').innerHTML = senpi.foto_senpi && senpi.foto_senpi !== '-' ? `<a href="${senpi.foto_senpi}" target="_blank">Lihat URL</a>` : 'Kosong';
            
            document.getElementById('editSimsaFotoSimsa').value = '';
            document.getElementById('editSimsaFotoSenpi').value = '';

            document.getElementById('editSimsaModal').style.display = 'flex';
        }
        
        document.getElementById('editSimsaTanggalTerbit').addEventListener('input', function() {
            const tanggalTerbitInput = this.value;
            if (tanggalTerbitInput) {
                const date = new Date(tanggalTerbitInput);
                date.setFullYear(date.getFullYear() + 1);
                document.getElementById('editSimsaTanggalExpired').value = formatDate(date);
            } else {
                document.getElementById('editSimsaTanggalExpired').value = '';
            }
        });

        // ✅ NEW PDF GENERATOR WITH QR CODE
        async function generatePDFWithQRCode(user, senpi, nrp) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Generate QR Code
            const qrCodeDataURL = await QRCodeGenerator.generateSenpiQRCode(nrp, senpi.nomor_seri);
            
            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('DATA SENPI - POLDA METRO JAYA', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('SISTEM TRACKING SENPI TERINTEGRASI', 105, 27, { align: 'center' });
            
            // Garis pemisah
            doc.setDrawColor(220, 38, 38);
            doc.setLineWidth(0.5);
            doc.line(20, 32, 190, 32);
            
            // Data Personel
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('DATA PERSONEL', 20, 45);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`NRP: ${nrp}`, 20, 55);
            doc.text(`Nama: ${user.nama}`, 20, 62);
            doc.text(`Pangkat: ${user.pangkat}`, 20, 69);
            doc.text(`Kesatuan: ${user.kesatuan}`, 20, 76);
            
            // Data Senpi
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('DATA SENPI', 20, 90);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nomor Seri: ${senpi.nomor_seri}`, 20, 100);
            doc.text(`Jenis: ${senpi.jenis}`, 20, 107);
            doc.text(`Keterangan: ${senpi.keterangan}`, 20, 114);
            doc.text(`Tanggal Terbit SIMSA: ${senpi.tanggal_terbit_simsa || '-'}`, 20, 121);
            doc.text(`Tanggal Expired: ${senpi.tanggal_expired || '-'}`, 20, 128);
            
            // Status
            let status = 'PENDING';
            if (senpi.tanggal_terbit_simsa) {
                if (senpi.tanggal_expired) {
                    const expiryDate = new Date(senpi.tanggal_expired);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    status = expiryDate < today ? 'EXPIRED' : 'AKTIF';
                } else {
                    status = 'AKTIF';
                }
            }
            
            doc.text(`Status: ${status}`, 20, 135);
            
            // QR Code
            doc.addImage(qrCodeDataURL, 'PNG', 140, 45, 40, 40);
            doc.setFontSize(8);
            doc.text('Scan untuk verifikasi', 140, 88, { align: 'center' });
            
            // Footer
            doc.setFontSize(8);
            doc.text(`Dokumen ini diverifikasi oleh Sistem Tracking Senpi Polda Metro Jaya`, 105, 150, { align: 'center' });
            doc.text(`Generated pada: ${new Date().toLocaleString()}`, 105, 155, { align: 'center' });
            
            return doc;
        }

        async function downloadPDF(nrp, senpiIndex) {
            try {
                const user = USERS_DATA[nrp];
                const senpi = user.senpi[senpiIndex];
                
                const doc = await generatePDFWithQRCode(user, senpi, nrp);
                doc.save(`senpi_${senpi.nomor_seri}_${nrp}.pdf`);
                
                // Log activity
                logActivity(nrp, 'download_pdf', { 
                    nomor_seri: senpi.nomor_seri,
                    filename: `senpi_${senpi.nomor_seri}_${nrp}.pdf`
                });
                
                alert('PDF berhasil didownload dengan QR Code!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Gagal generate PDF: ' + error.message);
            }
        }

        // === FORM SUBMIT HANDLER: Simpan ke server + sinkron ke Firebase ===
        document.getElementById('editSimsaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nrp = document.getElementById('editSimsaNrp').value;
            const index = parseInt(document.getElementById('editSimsaSenpiIndex').value);
            
            const newTanggalTerbit = document.getElementById('editSimsaTanggalTerbit').value.trim();
            const newTanggalExpired = document.getElementById('editSimsaTanggalExpired').value.trim();
            const fileSimsa = document.getElementById('editSimsaFotoSimsa').files[0];
            const fileSenpi = document.getElementById('editSimsaFotoSenpi').files[0];
            
            const senpi = USERS_DATA[nrp].senpi[index];
            
            if (!newTanggalTerbit || !newTanggalExpired) {
                alert('Tanggal Terbit dan Expired harus diisi!');
                return;
            }

            try {
                const btnSubmit = document.querySelector('#editSimsaForm .btn-submit');
                btnSubmit.disabled = true;
                const originalBtnHtml = btnSubmit.innerHTML;
                btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim Data...';

                // Baca file menjadi dataURL (jika ada)
                const [fotoSimsaBase64, fotoSenpiBase64] = await Promise.all([
                    readFileAsDataURL(fileSimsa).catch(() => null),
                    readFileAsDataURL(fileSenpi).catch(() => null)
                ]);

                // Siapkan payload ke server (jika server mendukung base64)
                const formObject = {
                    action: 'updateSenpiAnggota',
                    nrp: nrp,
                    nomor_seri: senpi.nomor_seri,
                    tanggal_terbit_simsa: newTanggalTerbit,
                    tanggal_expired: newTanggalExpired,
                    foto_simsa_base64: fotoSimsaBase64 || '',
                    foto_senpi_base64: fotoSenpiBase64 || ''
                };

                let result = null;
                try {
                    const response = await fetch(API_URL_EKSTERNAL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formObject)
                    });
                    result = await response.json();
                } catch (apiError) {
                    console.warn('API upload error:', apiError);
                    result = null;
                }

                // Update data lokal
                senpi.tanggal_terbit_simsa = newTanggalTerbit;
                senpi.tanggal_expired = newTanggalExpired;

                if (result && result.success) {
                    if (result.foto_simsa_url) {
                        senpi.foto_simsa = result.foto_simsa_url;
                    } else if (fotoSimsaBase64) {
                        senpi.foto_simsa = fotoSimsaBase64;
                    }
                    if (result.foto_senpi_url) {
                        senpi.foto_senpi = result.foto_senpi_url;
                    } else if (fotoSenpiBase64) {
                        senpi.foto_senpi = fotoSenpiBase64;
                    }
                } else {
                    // fallback kalau API gagal: simpan dataURL
                    if (fotoSimsaBase64) senpi.foto_simsa = fotoSimsaBase64;
                    if (fotoSenpiBase64) senpi.foto_senpi = fotoSenpiBase64;
                }

                // Sinkronkan USERS_DATA ke Firebase via queue
                saveUsersData();

                // Opsional: catat history senpi di Firebase
                try {
                    if (window.firebase && firebase.database) {
                        await firebase.database().ref(`senpi_history/${nrp}`).push({
                            nomor: senpi.nomor_seri,
                            action: 'update',
                            tanggal_terbit_simsa: newTanggalTerbit,
                            tanggal_expired: newTanggalExpired,
                            ts: new Date().toISOString()
                        });
                    }
                } catch (e) { console.warn('push senpi_history err', e); }

                // Log activity
                logActivity(nrp, 'input_data_simsa', { 
                    nomor_seri: senpi.nomor_seri,
                    tanggal_terbit_simsa: newTanggalTerbit,
                    tanggal_expired: newTanggalExpired
                });

                alert('Data SIMSA/Senpi berhasil disimpan!');
                closeModal('editSimsaModal');

                // Refresh tampilan
                displaySenpiList(nrp);

            } catch (err) {
                console.error('Gagal menyimpan data SIMSA:', err);
                alert('Gagal menyimpan data. Coba lagi.');
            } finally {
                const btnSubmit = document.querySelector('#editSimsaForm .btn-submit');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="fas fa-save"></i> Simpan & Upload';
            }
        });

        // Inisialisasi halaman
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
        });
    </script>
</body>
</html>
