<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Sistem Tracking Senpi (Realtime)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; margin:0;padding:0;font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    :root{--primary:#dc2626;--primary-dark:#b91c1c;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--dark:#1e293b;--light:#f8fafc;}
    body{background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);min-height:100vh;padding:24px}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;padding:18px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;box-shadow:0 8px 30px rgba(0,0,0,0.08)}
    .admin-info h1{color:var(--dark);font-size:1.6rem;margin-bottom:4px}
    .admin-info p{color:#64748b}
    .admin-badge{background:var(--primary);color:#fff;padding:8px 12px;border-radius:18px;font-weight:600}
    .logout-btn{background:var(--danger);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px}
    .action-card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);cursor:pointer}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:12px}
    .stat-card{background:#fff;padding:16px;border-radius:10px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .stat-number{font-size:2rem;font-weight:700;display:block;color:var(--dark)}
    .table-container{background:#fff;padding:14px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .table-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .search-filter input{padding:8px;border:1px solid #e5e7eb;border-radius:8px;min-width:240px}
    .modern-table{width:100%;border-collapse:collapse}
    .modern-table th{background:var(--light);padding:10px;text-align:left;border-bottom:1px solid #e6eef8;color:#64748b}
    .modern-table td{padding:10px;border-bottom:1px solid #f1f5f9;color:var(--dark)}
    .empty-state{text-align:center;padding:30px;color:#64748b}
    #liveMap{height:360px;border-radius:8px;border:1px solid #e5e7eb;margin-bottom:12px}
    .status-badge{padding:6px 10px;border-radius:20px;font-weight:600}
    .status-aktif{background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0}
    .status-pending{background:#fef3c7;color:#d97706;border:1px solid #fde68a}
    .status-expired{background:#fee2e2;color:#dc2626;border:1px solid #fecaca}
    .btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer}
    .btn-refresh{background:#fef3c7;color:#92400e}
    @media(max-width:768px){body{padding:12px}#liveMap{height:260px}}
    #rt-status{position:fixed;right:12px;bottom:12px;padding:8px 10px;background:#111827;color:#fff;border-radius:8px;font-size:12px;z-index:9999}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="admin-info">
        <h1>Dashboard Super Admin</h1>
        <p>Manajemen Data Senpi & Stealth Tracking (Realtime)</p>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <span class="admin-badge"><i class="fas fa-crown"></i> SUPER ADMIN</span>
        <button class="logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <div class="quick-actions">
      <div class="action-card" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i> <h4>Refresh Data</h4>
      </div>
      <div class="action-card" onclick="downloadAllData()">
        <i class="fas fa-file-export"></i> <h4>Export Data</h4>
      </div>
      <div class="action-card" onclick="showAddUserModal()">
        <i class="fas fa-user-plus"></i> <h4>Tambah Personel</h4>
      </div>
      <div class="action-card" onclick="showAddSenpiModal()">
        <i class="fas fa-plus-circle"></i> <h4>Tambah Senpi</h4>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><span class="stat-number" id="totalPersonel">0</span><div class="stat-label">Total Personel</div></div>
      <div class="stat-card"><span class="stat-number" id="totalSenpi">0</span><div class="stat-label">Total Senpi</div></div>
      <div class="stat-card"><span class="stat-number" id="senpiAktif">0</span><div class="stat-label">Senpi Aktif</div></div>
      <div class="stat-card"><span class="stat-number" id="senpiPending">0</span><div class="stat-label">Perlu Input Data</div></div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3><i class="fas fa-user-secret"></i> Live Stealth Tracking</h3>
        <div class="search-filter">
          <input id="searchTracking" placeholder="Cari nama atau NRP..." onkeyup="filterTrackingTable()" />
          <button class="btn btn-refresh" onclick="refreshStealthData()"> <i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>

      <div id="liveMap"></div>

      <table class="modern-table">
        <thead>
          <tr><th>NRP</th><th>Nama</th><th>Lokasi Terakhir</th><th>Akurasi</th><th>Update</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="trackingTable"><tr><td colspan="7" class="empty-state"><i class="fas fa-spinner fa-spin"></i> Memuat data tracking...</td></tr></tbody>
      </table>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3><i class="fas fa-users"></i> Data Semua Personel</h3>
        <div class="search-filter">
          <input id="searchUsers" placeholder="Cari nama atau NRP..." onkeyup="filterUsersTable()" />
          <button class="btn btn-refresh" onclick="refreshData()"> <i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>

      <table class="modern-table">
        <thead>
          <tr><th>NRP</th><th>Nama</th><th>Pangkat</th><th>Kesatuan</th><th>Jumlah Senpi</th><th>Status</th><th>Aksi</th></tr>
        </thead>
        <tbody id="allUsersTable"><tr><td colspan="7" class="empty-state"><i class="fas fa-spinner fa-spin"></i> Memuat data personel...</td></tr></tbody>
      </table>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3><i class="fas fa-gun"></i> Data Semua Senpi</h3>
        <div class="search-filter">
          <input id="searchSenpi" placeholder="Cari nomor seri..." onkeyup="filterSenpiTable()" />
          <button class="btn btn-refresh" onclick="refreshData()"> <i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>

      <table class="modern-table">
        <thead>
          <tr><th>Nomor Seri</th><th>Pemilik</th><th>NRP</th><th>Status</th><th>Tanggal SIMSA</th><th>Expired</th><th>Keterangan</th><th>Aksi</th></tr>
        </thead>
        <tbody id="allSenpiTable"><tr><td colspan="8" class="empty-state"><i class="fas fa-spinner fa-spin"></i> Memuat data senpi...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Realtime status -->
  <div id="rt-status">Loading...</div>

  <!-- Firebase SDKs and helper scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script src="js/firebase-init.js"></script>
  <script src="js/firebase-storage.js"></script>
  <script src="js/firebase-sync-queue.js"></script>
  <script src="js/firebase-listener.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // Admin dashboard JS (complete)
  window.USERS_DATA = {};
  window.SESSION_DATA = {};
  window.STEALTH_DATA = {};
  let adminMap = null; let adminMarkers = {};

  function showConnectionStatus(msg){ console.log('[STATUS]',msg); const el=document.getElementById('rt-status'); if(el) el.textContent=msg; }
  window.addEventListener('online', ()=>showConnectionStatus('Online'));
  window.addEventListener('offline', ()=>showConnectionStatus('Offline'));

  function initMap(){ try{ adminMap=L.map('liveMap').setView([-6.2,106.8166],10); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'Â© OpenStreetMap contributors' }).addTo(adminMap);}catch(e){console.warn('initMap',e);} }

  function renderStats(){ const total=Object.keys(window.USERS_DATA||{}).length; document.getElementById('totalPersonel').textContent=total; let totalSenpi=0,aktif=0,pending=0; Object.values(window.USERS_DATA).forEach(u=>{ if(u.senpi&&Array.isArray(u.senpi)){ totalSenpi+=u.senpi.length; aktif+=u.senpi.filter(s=>s.status==='aktif').length; pending+=u.senpi.filter(s=>!s.status||s.status==='pending').length; }}); document.getElementById('totalSenpi').textContent=totalSenpi; document.getElementById('senpiAktif').textContent=aktif; document.getElementById('senpiPending').textContent=pending; }

  function renderUsersTable(filter=''){ const tbody=document.getElementById('allUsersTable'); const users=window.USERS_DATA||{}; const keys=Object.keys(users).filter(k=>{ if(!filter) return true; const q=filter.toLowerCase(); const u=users[k]; return k.includes(q)|| (u.nama&&u.nama.toLowerCase().includes(q)); }).sort(); if(keys.length===0){ tbody.innerHTML='<tr><td colspan="7" class="empty-state">Tidak ada personel</td></tr>'; return; } tbody.innerHTML=keys.map(nrp=>{ const u=users[nrp]; const senpiCount=(u.senpi&&u.senpi.length)||0; return `<tr><td><strong>${nrp}</strong></td><td>${u.nama||''}</td><td>${u.pangkat||''}</td><td>${u.kesatuan||''}</td><td>${senpiCount}</td><td>${(window.SESSION_DATA&&window.SESSION_DATA[nrp])?'<span class="status-badge status-aktif">ONLINE</span>':'<span class="status-badge status-expired">OFFLINE</span>'}</td><td><button class="btn btn-refresh" onclick="forceRefreshUser('${nrp}')"><i class="fas fa-sync-alt"></i></button></td></tr>`; }).join(''); }

  function renderTrackingTable(filter=''){ const tbody=document.getElementById('trackingTable'); const users=window.USERS_DATA||{}; const nrps=Object.keys(users).sort(); if(nrps.length===0){ tbody.innerHTML='<tr><td colspan="7" class="empty-state">Tidak ada data tracking</td></tr>'; return; } tbody.innerHTML=nrps.filter(nrp=>{ if(!filter) return true; const q=filter.toLowerCase(); const u=users[nrp]||{}; return nrp.includes(q)|| (u.nama&&u.nama.toLowerCase().includes(q)); }).map(nrp=>{ const user=users[nrp]||{}; const locs=(STEALTH_DATA[nrp]||[]); const last=locs.length?locs[locs.length-1]:null; let coords='-',acc='-',update='-'; let statusClass='status-expired', statusText='OFFLINE'; if(last){ coords=`${last.lat.toFixed(4)}, ${last.lng.toFixed(4)}`; acc=`${Math.round(last.accuracy)}m`; const minutes=Math.floor((Date.now()-new Date(last.timestamp))/60000); statusClass=minutes<=10?'status-aktif':minutes<=60?'status-pending':'status-expired'; statusText=minutes<=10?'ONLINE':minutes<=60?'IDLE':'OFFLINE'; update=`${minutes} menit lalu`; } else if(window.SESSION_DATA&&window.SESSION_DATA[nrp]){ statusClass='status-aktif'; statusText='ONLINE'; } return `<tr><td><strong>${nrp}</strong></td><td>${user.nama||''}</td><td>${coords}</td><td>${acc}</td><td>${update}</td><td><span class="status-badge ${statusClass}">${statusText}</span></td><td><button class="btn" onclick="viewStealthHistory('${nrp}')"><i class="fas fa-history"></i></button></td></tr>`; }).join(''); }

  function renderSenpiTable(filter=''){ const tbody=document.getElementById('allSenpiTable'); const rows=[]; Object.entries(window.USERS_DATA||{}).forEach(([nrp,u])=>{ const senpis=u.senpi||[]; senpis.forEach(s=>{ if(!filter|| (s.nomorSeri&&s.nomorSeri.toLowerCase().includes(filter.toLowerCase()))){ rows.push({ nomor:s.nomorSeri||'', pemilik:u.nama||'', nrp, status:s.status||'', tgl:s.tanggal||'', expired:s.expired||'', keterangan:s.keterangan||'' }); } }); }); if(rows.length===0){ tbody.innerHTML='<tr><td colspan="8" class="empty-state">Tidak ada data senpi</td></tr>'; return; } tbody.innerHTML=rows.map(r=>`<tr><td>${r.nomor}</td><td>${r.pemilik}</td><td>${r.nrp}</td><td>${r.status}</td><td>${r.tgl}</td><td>${r.expired}</td><td>${r.keterangan}</td><td><button class="btn" onclick="viewSenpi('${r.nomor}')"><i class="fas fa-eye"></i></button></td></tr>`).join(''); }

  function filterUsersTable(){ renderUsersTable(document.getElementById('searchUsers').value.trim()); }
  function filterTrackingTable(){ renderTrackingTable(document.getElementById('searchTracking').value.trim()); }
  function filterSenpiTable(){ renderSenpiTable(document.getElementById('searchSenpi').value.trim()); }
  function showAddUserModal(){ alert('Form tambah personel (belum diimplementasi)'); }
  function showAddSenpiModal(){ alert('Form tambah senpi (belum diimplementasi)'); }
  function viewStealthHistory(nrp){ const arr=STEALTH_DATA[nrp]||[]; if(arr.length===0){ alert('Tidak ada stealth data'); return; } const last=arr.slice(-10).reverse().map((p,i)=>`${i+1}. ${new Date(p.timestamp).toLocaleString()} â€” ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)} (acc ${Math.round(p.accuracy)}m)`).join('\n\n'); alert(`Stealth history ${nrp}:\n\n${last}`); }
  function viewSenpi(nomor){ alert('Preview senpi: '+nomor); }
  function forceRefreshUser(nrp){ alert('Force refresh untuk '+nrp); }
  function logout(){ localStorage.removeItem('isAdmin'); localStorage.removeItem('adminNrp'); window.location.href='index.html'; }

  async function loadData(){ try{ let data=null; if(window.firebaseGetTempUsersData){ try{ data=await firebaseGetTempUsersData(); }catch(e){ data=null; } } if(!data){ const resp=await fetch('data.json'); if(!resp.ok) throw new Error('data.json not found'); data=await resp.json(); } const users=data.users||data; window.USERS_DATA=users||{}; try{ localStorage.setItem('temp_users_data', JSON.stringify(window.USERS_DATA)); }catch(e){} renderStats(); renderUsersTable(); renderTrackingTable(); renderSenpiTable(); }catch(e){ console.error('loadData error',e); alert('Gagal memuat data. Periksa console.'); } }

  function setupRealtime(){ // sessions
    if(window.firebaseListeners && typeof firebaseListeners.subscribeSessions==='function'){ firebaseListeners.subscribeSessions(sessions=>{ window.SESSION_DATA=sessions||{}; console.log('[RT] sessions count=',Object.keys(window.SESSION_DATA).length); renderUsersTable(); renderTrackingTable(); renderStats(); }); } else console.warn('firebaseListeners.subscribeSessions not available');
    // lastKnownLocations
    if(window.firebaseListeners && typeof firebaseListeners.subscribeLastLocations==='function'){ firebaseListeners.subscribeLastLocations(500,(key,loc)=>{ try{ const nrp=loc && (loc.nrp||loc.owner||'unknown'); if(!STEALTH_DATA[nrp]) STEALTH_DATA[nrp]=[]; STEALTH_DATA[nrp].push(loc); if(STEALTH_DATA[nrp].length>500) STEALTH_DATA[nrp].splice(0,STEALTH_DATA[nrp].length-500); try{ localStorage.setItem('stealth_location_data', JSON.stringify(STEALTH_DATA)); }catch(e){} updateMarkerFor(nrp,loc); renderTrackingTable(); console.log('[RT] loc added',nrp,key,loc); }catch(e){console.warn('handle loc err',e);} }); } else console.warn('firebaseListeners.subscribeLastLocations not available'); }

  function updateMarkerFor(nrp,loc){ try{ const lat=Number(loc.lat), lng=Number(loc.lng); if(isNaN(lat)||isNaN(lng)) return; if(adminMarkers[nrp]){ adminMap.removeLayer(adminMarkers[nrp]); delete adminMarkers[nrp]; } const icon=L.divIcon({ html:'ðŸ¦‡', className:'stealth-marker-icon', iconSize:[24,24] }); const m=L.marker([lat,lng],{icon}).addTo(adminMap).bindPopup(`<strong>${(USERS_DATA[nrp]&&USERS_DATA[nrp].nama)||nrp}</strong><br>NRP: ${nrp}<br>Acc: ${Math.round(loc.accuracy)}m<br>${new Date(loc.timestamp).toLocaleString()}`); adminMarkers[nrp]=m; }catch(e){console.warn('updateMarkerFor',e);} }

  function refreshStealthData(){ try{ Object.keys(STEALTH_DATA).forEach(nrp=>{ const arr=STEALTH_DATA[nrp]; if(arr&&arr.length) updateMarkerFor(nrp,arr[arr.length-1]); }); }catch(e){console.warn('refreshStealthData',e);} }
  function refreshData(){ loadData(); }
  function downloadAllData(){ const payload={ users:window.USERS_DATA, sessions:window.SESSION_DATA, stealth:STEALTH_DATA }; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`track-senpi-export-${new Date().toISOString().slice(0,10)}.json`; a.click(); }

  // Init
  document.addEventListener('DOMContentLoaded', async ()=>{
    if(!localStorage.getItem('isAdmin')){ alert('Akses ditolak. Silakan login sebagai admin.'); window.location.href='index.html'; return; }
    showConnectionStatus('Initializing...');
    initMap(); try{ STEALTH_DATA=JSON.parse(localStorage.getItem('stealth_location_data')||'{}'); }catch(e){ STEALTH_DATA={}; }
    await loadData();
    setupRealtime();
    // populate existing stealth markers
    Object.keys(STEALTH_DATA).forEach(nrp=>{ const arr=STEALTH_DATA[nrp]; if(arr&&arr.length) updateMarkerFor(nrp,arr[arr.length-1]); });
    showConnectionStatus('Realtime ready');
  });
  </script>
</body>
</html>